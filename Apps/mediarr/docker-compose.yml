name: mediarr

# ‚îÄ‚îÄ‚îÄ Reusable anchors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

x-vpn-service: &vpn-service
  depends_on:
    vpn:
      condition: service_healthy
  network_mode: service:vpn
  restart: unless-stopped

x-common-env: &common-env
  PUID: $PUID
  PGID: $PGID
  TZ: $TZ

x-services-auth: &services-auth
  SERVICES_USERNAME: admin
  SERVICES_PASSWORD: "mediarr"

# ‚îÄ‚îÄ‚îÄ Services ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

services:
  # ‚îÄ‚îÄ Mediarr Hub ‚Äî Landing page / dashboard for all services ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  #
  # A lightweight nginx page that serves as the homescreen entry point.
  # Links to all Mediarr services and shows live status indicators.
  # The HTML is written inline so no external files are needed.
  hub:
    image: nginx:alpine
    container_name: mediarr-hub
    network_mode: bridge
    ports:
      - target: 80
        published: "8974"
        protocol: tcp
    deploy:
      resources:
        reservations:
          memory: 16M
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - |
        cat > /usr/share/nginx/html/index.html << 'HTMLEOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Mediarr</title>
          <style>
            *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: #0d1117;
              color: #e6edf3;
              min-height: 100vh;
              padding: 2.5rem 1.5rem;
            }
            header {
              text-align: center;
              margin-bottom: 2.5rem;
            }
            .logo {
              font-size: 2.75rem;
              font-weight: 800;
              letter-spacing: -0.03em;
              background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 50%, #fd79a8 100%);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
              background-clip: text;
              margin-bottom: 0.4rem;
            }
            .subtitle {
              color: #6e7681;
              font-size: 0.9rem;
            }
            .grid {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
              gap: 1rem;
              max-width: 1100px;
              margin: 0 auto;
            }
            .card {
              background: #161b22;
              border: 1px solid #21262d;
              border-radius: 12px;
              padding: 1.25rem 1.5rem;
              text-decoration: none;
              color: inherit;
              display: flex;
              flex-direction: column;
              gap: 0.6rem;
              transition: border-color 0.15s, transform 0.15s, box-shadow 0.15s;
            }
            .card:hover {
              border-color: #6c5ce7;
              transform: translateY(-2px);
              box-shadow: 0 8px 32px rgba(108, 92, 231, 0.18);
            }
            .card-top {
              display: flex;
              align-items: center;
              gap: 0.85rem;
            }
            .icon-wrap {
              width: 46px;
              height: 46px;
              border-radius: 10px;
              background: #21262d;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.5rem;
              flex-shrink: 0;
            }
            .card-name {
              flex: 1;
            }
            .card-name h3 {
              font-size: 1rem;
              font-weight: 600;
              line-height: 1.3;
            }
            .card-port {
              font-size: 0.7rem;
              color: #6e7681;
              font-family: 'SF Mono', 'Fira Code', monospace;
              margin-top: 1px;
            }
            .dot {
              width: 9px;
              height: 9px;
              border-radius: 50%;
              background: #21262d;
              flex-shrink: 0;
              transition: background 0.4s, box-shadow 0.4s;
            }
            .dot.up   { background: #3fb950; box-shadow: 0 0 7px rgba(63,185,80,0.6); }
            .dot.down { background: #f85149; }
            .card-desc {
              font-size: 0.8rem;
              color: #6e7681;
              line-height: 1.55;
            }
            .badge {
              display: inline-flex;
              align-items: center;
              gap: 3px;
              font-size: 0.65rem;
              font-weight: 500;
              color: #a29bfe;
              background: rgba(108, 92, 231, 0.12);
              border: 1px solid rgba(108, 92, 231, 0.25);
              border-radius: 4px;
              padding: 2px 7px;
              width: fit-content;
            }
            footer {
              text-align: center;
              margin-top: 2.5rem;
              color: #30363d;
              font-size: 0.75rem;
            }
          </style>
        </head>
        <body>
          <header>
            <div class="logo">Mediarr</div>
            <p class="subtitle">VPN-protected home media stack</p>
          </header>

          <div class="grid" id="grid"></div>

          <footer>All torrent traffic is routed through your VPN &bull; Status auto-refreshes every 30s</footer>

          <script>
            const host = window.location.hostname;

            const services = [
              {
                id: 'jellyfin',
                name: 'Jellyfin',
                icon: 'üé¨',
                port: 8096,
                desc: 'Stream your movies and TV shows to any device',
                vpn: false
              },
              {
                id: 'jellyseerr',
                name: 'Jellyseerr',
                icon: 'üîç',
                port: 5055,
                desc: 'Browse and request new movies and TV shows',
                vpn: true
              },
              {
                id: 'radarr',
                name: 'Radarr',
                icon: 'üé•',
                port: 7878,
                desc: 'Automatic movie collection manager',
                vpn: true
              },
              {
                id: 'sonarr',
                name: 'Sonarr',
                icon: 'üì∫',
                port: 8989,
                desc: 'Automatic TV show collection manager',
                vpn: true
              },
              {
                id: 'prowlarr',
                name: 'Prowlarr',
                icon: 'üì°',
                port: 9696,
                desc: 'Indexer manager ‚Äî syncs trackers across all apps',
                vpn: true
              },
              {
                id: 'qbittorrent',
                name: 'qBittorrent',
                icon: '‚¨áÔ∏è',
                port: 8080,
                desc: 'BitTorrent client with web interface',
                vpn: true
              }
            ];

            const grid = document.getElementById('grid');

            services.forEach(function(s) {
              const url = 'http://' + host + ':' + s.port;
              const card = document.createElement('a');
              card.href = url;
              card.target = '_blank';
              card.rel = 'noopener noreferrer';
              card.className = 'card';
              card.innerHTML =
                '<div class="card-top">' +
                  '<div class="icon-wrap">' + s.icon + '</div>' +
                  '<div class="card-name">' +
                    '<h3>' + s.name + '</h3>' +
                    '<div class="card-port">:' + s.port + '</div>' +
                  '</div>' +
                  '<div class="dot" id="dot-' + s.id + '"></div>' +
                '</div>' +
                '<div class="card-desc">' + s.desc + '</div>' +
                (s.vpn ? '<span class="badge">üîí VPN</span>' : '');
              grid.appendChild(card);
            });

            function checkAll() {
              services.forEach(function(s) {
                const dot = document.getElementById('dot-' + s.id);
                const url = 'http://' + host + ':' + s.port;
                const ctrl = new AbortController();
                const timer = setTimeout(function() { ctrl.abort(); }, 4000);
                fetch(url, { mode: 'no-cors', signal: ctrl.signal })
                  .then(function() {
                    clearTimeout(timer);
                    dot.className = 'dot up';
                  })
                  .catch(function() {
                    dot.className = 'dot down';
                  });
              });
            }

            checkAll();
            setInterval(checkAll, 30000);
          </script>
        </body>
        </html>
        HTMLEOF
        exec nginx -g 'daemon off;'
    x-casaos:
      ports:
        - container: "80"
          description:
            en_us: Mediarr Hub dashboard

  # ‚îÄ‚îÄ VPN Gateway ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  vpn:
    image: qmcgaw/gluetun:latest
    container_name: mediarr-vpn
    cap_add:
      - NET_ADMIN
    networks:
      - mediarr_net
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/gluetun
        target: /tmp/gluetun
    environment:
      # VPN provider ‚Äî supports all Gluetun providers (protonvpn, mullvad, nordvpn, etc.)
      VPN_SERVICE_PROVIDER: protonvpn
      # VPN protocol ‚Äî openvpn or wireguard
      VPN_TYPE: openvpn
      # OpenVPN credentials (used when VPN_TYPE=openvpn)
      OPENVPN_USER: ""
      OPENVPN_PASSWORD: ""
      # WireGuard credentials (used when VPN_TYPE=wireguard)
      WIREGUARD_PRIVATE_KEY: ""
      WIREGUARD_ADDRESS: ""
      # Server preference
      SERVER_COUNTRIES: Netherlands
      # Port forwarding (set to off if your VPN provider doesn't support it)
      VPN_PORT_FORWARDING: "on"
      # When a forwarded port is obtained, update qBittorrent's listening port automatically
      VPN_PORT_FORWARDING_UP_COMMAND: >-
        /bin/sh -c
        'wget -q -O- --post-data "json={\"listen_port\":{{PORT}}}"
        "http://localhost:8080/api/v2/app/setPreferences" 2>/dev/null; true'
      LOG_LEVEL: debug
    ports:
      # qBittorrent WebUI
      - target: 8080
        published: "8080"
        protocol: tcp
      # qBittorrent torrent port (for seeding/leeching)
      - target: 6881
        published: "6881"
        protocol: tcp
      - target: 6881
        published: "6881"
        protocol: udp
      # Prowlarr
      - target: 9696
        published: "9696"
        protocol: tcp
      # Radarr
      - target: 7878
        published: "7878"
        protocol: tcp
      # Sonarr
      - target: 8989
        published: "8989"
        protocol: tcp
      # Jellyseerr
      - target: 5055
        published: "5055"
        protocol: tcp
      # FlareSolverr (exposed for debugging; normally only used internally by Prowlarr)
      - target: 8191
        published: "8191"
        protocol: tcp
    restart: unless-stopped
    x-casaos:
      envs:
        - container: VPN_SERVICE_PROVIDER
          description:
            en_us: "VPN provider name (e.g. protonvpn, mullvad, nordvpn). See Gluetun docs for full list."
        - container: VPN_TYPE
          description:
            en_us: "VPN protocol: openvpn or wireguard"
        - container: OPENVPN_USER
          description:
            en_us: "OpenVPN username (required when VPN_TYPE=openvpn). For ProtonVPN, append +pmp to username."
        - container: OPENVPN_PASSWORD
          description:
            en_us: "OpenVPN password (required when VPN_TYPE=openvpn)"
        - container: WIREGUARD_PRIVATE_KEY
          description:
            en_us: "WireGuard private key (required when VPN_TYPE=wireguard)"
        - container: WIREGUARD_ADDRESS
          description:
            en_us: "WireGuard interface address e.g. 10.64.0.1/32 (required when VPN_TYPE=wireguard)"
        - container: SERVER_COUNTRIES
          description:
            en_us: "Preferred VPN server country (e.g. Netherlands, Switzerland)"
        - container: VPN_PORT_FORWARDING
          description:
            en_us: "Enable VPN port forwarding for better torrent performance (on/off). Not all providers support this."
      ports:
        - container: "8080"
          description:
            en_us: qBittorrent WebUI
        - container: "9696"
          description:
            en_us: Prowlarr WebUI
        - container: "7878"
          description:
            en_us: Radarr WebUI
        - container: "8989"
          description:
            en_us: Sonarr WebUI
        - container: "5055"
          description:
            en_us: Jellyseerr WebUI
        - container: "8191"
          description:
            en_us: FlareSolverr (internal Cloudflare bypass proxy)
        - container: "6881"
          description:
            en_us: qBittorrent torrent port (TCP)
        - container: "6881"
          description:
            en_us: qBittorrent torrent port (UDP)
          protocol: udp
      volumes:
        - container: /tmp/gluetun
          description:
            en_us: Gluetun VPN state and certificates

  # ‚îÄ‚îÄ Prowlarr ‚Äî Indexer Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  prowlarr:
    image: linuxserver/prowlarr:1.37.0
    environment:
      <<: *common-env
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/prowlarr
        target: /config
    <<: *vpn-service
    x-casaos:
      volumes:
        - container: /config
          description:
            en_us: Prowlarr configuration and database

  # ‚îÄ‚îÄ Radarr ‚Äî Movie Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  radarr:
    image: lscr.io/linuxserver/radarr:5.26.2
    environment:
      <<: *common-env
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/radarr
        target: /config
      - type: bind
        source: /DATA/Media/Movies
        target: /data/movies
      - type: bind
        source: /DATA/Downloads
        target: /downloads
    <<: *vpn-service
    x-casaos:
      volumes:
        - container: /config
          description:
            en_us: Radarr configuration and database
        - container: /data/movies
          description:
            en_us: Movie library directory (shared with Jellyfin)
        - container: /downloads
          description:
            en_us: Download directory (shared with qBittorrent)

  # ‚îÄ‚îÄ Sonarr ‚Äî TV Show Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  sonarr:
    image: lscr.io/linuxserver/sonarr:4.0.15
    environment:
      <<: *common-env
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/sonarr
        target: /config
      - type: bind
        source: /DATA/Media/TV Shows
        target: /data/tv
      - type: bind
        source: /DATA/Downloads
        target: /downloads
    <<: *vpn-service
    x-casaos:
      volumes:
        - container: /config
          description:
            en_us: Sonarr configuration and database
        - container: /data/tv
          description:
            en_us: TV show library directory (shared with Jellyfin)
        - container: /downloads
          description:
            en_us: Download directory (shared with qBittorrent)

  # ‚îÄ‚îÄ qBittorrent Credential Setup ‚Äî Runs once before qBittorrent starts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  #
  # Creates qBittorrent.conf with a PBKDF2-hashed password derived from
  # SERVICES_PASSWORD before qBittorrent starts, so it never generates a random
  # temporary password. Uses /state/qb-credentials-set as a one-shot flag.
  qb-setup:
    image: python:3-alpine
    environment:
      <<: *services-auth
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/qbittorrent
        target: /qb-config
      - type: bind
        source: /DATA/AppData/$AppID/configurator
        target: /state
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "test", "-f", "/state/qb-credentials-set"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 5s
    command:
      - /bin/sh
      - -c
      - |
        set -e
        if [ -f /state/qb-credentials-set ]; then
          echo "[qb-setup] Credentials already configured."
          exec tail -f /dev/null
        fi
        echo "[qb-setup] Writing qBittorrent credentials..."
        python3 - << 'PYEOF'
        import hashlib, os, base64, sys
        username = os.environ.get("SERVICES_USERNAME", "admin")
        password = os.environ.get("SERVICES_PASSWORD", "")
        conf_dir = "/qb-config/qBittorrent"
        os.makedirs(conf_dir, exist_ok=True)
        conf_file = conf_dir + "/qBittorrent.conf"
        if os.path.exists(conf_file):
            print("[qb-setup] qBittorrent.conf already exists, skipping.")
            sys.exit(0)
        salt = os.urandom(16)
        dk = hashlib.pbkdf2_hmac("sha512", password.encode("utf-8"), salt, 100000)
        hash_str = "@ByteArray(" + base64.b64encode(salt).decode() + ":" + base64.b64encode(dk).decode() + ")"
        config  = "[BitTorrent]\n"
        config += "Session\\DefaultSavePath=/downloads\n"
        config += "Session\\TempPath=/downloads/incomplete/\n"
        config += "Session\\TempPathEnabled=true\n"
        config += "\n[Preferences]\n"
        config += "WebUI\\Username=" + username + "\n"
        config += "WebUI\\Password_PBKDF2=" + hash_str + "\n"
        config += "WebUI\\AuthSubnetWhitelistEnabled=true\n"
        config += "WebUI\\AuthSubnetWhitelist=127.0.0.0/8\n"
        with open(conf_file, "w") as f:
            f.write(config)
        print("[qb-setup] Credentials written (user: " + username + ")")
        PYEOF
        touch /state/qb-credentials-set
        echo "[qb-setup] Done."
        exec tail -f /dev/null

  # ‚îÄ‚îÄ qBittorrent ‚Äî Torrent Client ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  qbittorrent:
    image: linuxserver/qbittorrent:4.6.7
    environment:
      <<: *common-env
      WEBUI_PORT: "8080"
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/qbittorrent
        target: /config
      - type: bind
        source: /DATA/Downloads
        target: /downloads
    <<: *vpn-service
    depends_on:
      vpn:
        condition: service_healthy
      qb-setup:
        condition: service_healthy
    x-casaos:
      envs:
        - container: WEBUI_PORT
          description:
            en_us: qBittorrent Web UI port (do not change)
      volumes:
        - container: /config
          description:
            en_us: qBittorrent configuration
        - container: /downloads
          description:
            en_us: Download directory

  # ‚îÄ‚îÄ FlareSolverr ‚Äî Cloudflare Bypass ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:v3.4.5
    environment:
      TZ: $TZ
      LOG_LEVEL: info
      LOG_HTML: "false"
      CAPTCHA_SOLVER: "none"
    <<: *vpn-service
    x-casaos:
      envs:
        - container: LOG_LEVEL
          description:
            en_us: FlareSolverr log verbosity (info, debug, warning)

  # ‚îÄ‚îÄ Jellyfin ‚Äî Media Server ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  jellyfin:
    image: linuxserver/jellyfin:10.10.7
    container_name: mediarr-jellyfin
    environment:
      <<: *common-env
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/jellyfin
        target: /config
      - type: bind
        source: /DATA/Media/Movies
        target: /data/movies
      - type: bind
        source: /DATA/Media/TV Shows
        target: /data/tv
    # Optional: uncomment for hardware-accelerated transcoding
    # devices:
    #   - /dev/dri:/dev/dri
    deploy:
      resources:
        reservations:
          memory: 256M
    # On mediarr_net so Jellyseerr can reach Jellyfin as "jellyfin:8096" via Docker DNS
    networks:
      - mediarr_net
    ports:
      - target: 8096
        published: "8096"
        protocol: tcp
      # Jellyfin auto-discovery (optional, for LAN clients)
      - target: 7359
        published: "7359"
        protocol: udp
    restart: unless-stopped
    x-casaos:
      envs:
        - container: PUID
          description:
            en_us: Run Jellyfin as specified user ID
        - container: PGID
          description:
            en_us: Run Jellyfin as specified group ID
        - container: TZ
          description:
            en_us: Timezone
      ports:
        - container: "8096"
          description:
            en_us: Jellyfin Web UI (HTTP)
        - container: "7359"
          description:
            en_us: Jellyfin auto-discovery (LAN)
          protocol: udp
      volumes:
        - container: /config
          description:
            en_us: Jellyfin configuration, metadata cache, and database
        - container: /data/movies
          description:
            en_us: Movie library (shared with Radarr)
        - container: /data/tv
          description:
            en_us: TV show library (shared with Sonarr)

  # ‚îÄ‚îÄ Jellyseerr ‚Äî Media Request Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  jellyseerr:
    image: fallenbagel/jellyseerr:2.7.3
    environment:
      TZ: $TZ
      PORT: "5055"
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/jellyseerr
        target: /app/config
    <<: *vpn-service
    x-casaos:
      envs:
        - container: TZ
          description:
            en_us: Timezone
      volumes:
        - container: /app/config
          description:
            en_us: Jellyseerr configuration and database

  # ‚îÄ‚îÄ Mediarr Configurator ‚Äî Auto-wires all services on first install ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  #
  # This init container runs once after all *arr services start.
  # It reads API keys from config files and calls each service's REST API to:
  #   - Set up qBittorrent auth bypass for localhost
  #   - Add qBittorrent as download client in Radarr and Sonarr
  #   - Set movie/TV root folders in Radarr and Sonarr
  #   - Add FlareSolverr proxy in Prowlarr
  #   - Register Radarr and Sonarr as apps in Prowlarr
  #
  # After first successful run, /state/configured is created and future
  # starts are instant no-ops.
  configurator:
    image: alpine:3.19
    environment:
      <<: *services-auth
    depends_on:
      vpn:
        condition: service_healthy
      radarr:
        condition: service_started
      sonarr:
        condition: service_started
      prowlarr:
        condition: service_started
      qbittorrent:
        condition: service_started
    network_mode: service:vpn
    restart: on-failure
    volumes:
      - type: bind
        source: /DATA/AppData/$AppID/radarr
        target: /radarr-config
        read_only: true
      - type: bind
        source: /DATA/AppData/$AppID/sonarr
        target: /sonarr-config
        read_only: true
      - type: bind
        source: /DATA/AppData/$AppID/prowlarr
        target: /prowlarr-config
        read_only: true
      - type: bind
        source: /DATA/AppData/$AppID/qbittorrent
        target: /qbittorrent-config
      - type: bind
        source: /DATA/AppData/$AppID/configurator
        target: /state
      - type: bind
        source: /DATA/AppData/$AppID/jellyseerr
        target: /jellyseerr-config
        read_only: true
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache curl jq wget
        wget -qO /tmp/mediarr-configurator.sh \
          https://raw.githubusercontent.com/vantezzen/casaos-apps/main/Apps/mediarr/configurator.sh
        exec sh /tmp/mediarr-configurator.sh
    x-casaos:
      envs:
        - container: SERVICES_USERNAME
          description:
            en_us: "Login username for qBittorrent, Radarr, Sonarr, and Prowlarr (default: admin)"
        - container: SERVICES_PASSWORD
          description:
            en_us: "Login password for all services. Leave empty for no password, or set a strong one."

# ‚îÄ‚îÄ‚îÄ Networks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

networks:
  mediarr_net:
    name: mediarr_net
    driver: bridge

# ‚îÄ‚îÄ‚îÄ CasaOS App Metadata ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

x-casaos:
  architectures:
    - amd64
    - arm64
  main: hub
  store_app_id: mediarr
  author: vantezzen
  category: Media
  description:
    en_us: |
      Mediarr is a complete, zero-configuration home media stack ‚Äî all bundled into a single install.

      It includes everything you need to find, download, organize, and watch your movies and TV shows:

      ‚Ä¢ **Radarr** ‚Äî Automatically monitors RSS feeds and downloads movies in your preferred quality
      ‚Ä¢ **Sonarr** ‚Äî Same as Radarr but for TV shows, managing entire seasons automatically
      ‚Ä¢ **Prowlarr** ‚Äî Central indexer manager that syncs your trackers to both Radarr and Sonarr
      ‚Ä¢ **qBittorrent** ‚Äî Fast, lightweight BitTorrent client with a clean web interface
      ‚Ä¢ **FlareSolverr** ‚Äî Automatically bypasses Cloudflare-protected torrent indexers
      ‚Ä¢ **Jellyfin** ‚Äî Beautiful, open-source media server to stream your library to any device
      ‚Ä¢ **Jellyseerr** ‚Äî Friendly interface for requesting new movies and shows

      All traffic is routed through your VPN via Gluetun, supporting ProtonVPN, Mullvad, NordVPN, and any other Gluetun-compatible provider.

      After installation, Mediarr's built-in configurator automatically wires all services together ‚Äî no manual setup of download clients, root folders, or app connections required.

      Open the Mediarr Hub (the app's main page) to navigate to all individual services.
  developer: vantezzen
  icon: https://cdn.jsdelivr.net/gh/IceWhaleTech/CasaOS-AppStore@main/Apps/Jellyfin/icon.png
  screenshot_link:
    - https://cdn.jsdelivr.net/gh/IceWhaleTech/CasaOS-AppStore@main/Apps/Jellyfin/screenshot-1.png
    - https://cdn.jsdelivr.net/gh/IceWhaleTech/CasaOS-AppStore@main/Apps/Jellyfin/screenshot-2.png
    - https://cdn.jsdelivr.net/gh/IceWhaleTech/CasaOS-AppStore@main/Apps/Jellyfin/screenshot-3.png
  thumbnail: https://cdn.jsdelivr.net/gh/IceWhaleTech/CasaOS-AppStore@main/Apps/Jellyfin/thumbnail.png
  tagline:
    en_us: Complete VPN-protected home media stack
  title:
    en_us: Mediarr
  index: /
  port_map: "8974"
  tips:
    before_install:
      en_us: |
        ## How to install

        The default credentials are `admin` / `mediarr`. Optionally change them by filling in `SERVICES_USERNAME` and `SERVICES_PASSWORD` in the "configurator" service **before** starting.

        Set your VPN credentials in the environment variables of the "vpn" service **before** starting Mediarr!
        Gluetun supports all major VPN providers. See the [Gluetun provider docs](https://github.com/qdm12/gluetun-wiki/tree/main/setup/providers) for the exact variables your provider needs.

        **ProtonVPN (OpenVPN) example:**
        | Variable | Value |
        |---|---|
        | `VPN_SERVICE_PROVIDER` | `protonvpn` |
        | `VPN_TYPE` | `openvpn` |
        | `OPENVPN_USER` | Your username **+ `+pmp`** (e.g. `user+pmp`) |
        | `OPENVPN_PASSWORD` | Your password |

        **Mullvad (WireGuard) example:**
        | Variable | Value |
        |---|---|
        | `VPN_SERVICE_PROVIDER` | `mullvad` |
        | `VPN_TYPE` | `wireguard` |
        | `WIREGUARD_PRIVATE_KEY` | Your WireGuard private key |
        | `WIREGUARD_ADDRESS` | e.g. `10.64.0.1/32` |

        ‚ö†Ô∏è Set `VPN_PORT_FORWARDING=off` if your provider doesn't support it!

        ## Using an External Drive (Optional)

        By default Mediarr stores everything on your main drive:

        | What | Default path |
        |---|---|
        | Downloads (in-progress) | `/DATA/Downloads` |
        | Movies library | `/DATA/Media/Movies` |
        | TV Shows library | `/DATA/Media/TV Shows` |

        To use an external drive, open the **Settings** tab before installing and change the host-side paths under **Volumes**:
        - `radarr` / `sonarr` / `jellyfin` ‚Äî change `/DATA/Media/Movies` and `/DATA/Media/TV Shows`
        - `qbittorrent` / `radarr` / `sonarr` ‚Äî change `/DATA/Downloads`

        In CasaOS you can also find external drives mounted under `/mnt/` (e.g. `/mnt/sda1/`).
        Make sure the directories exist on the drive before installing.

        ## After Installation

        Installation takes a little while since it sets up a lot of services for you.

        1. **Wait ~2 minutes** for the auto-configurator to wire all services together.
        2. **Set up Jellyfin** (`:8096`) ‚Äî on first launch add `/data/movies` and `/data/tv` as media libraries.
        3. **Set up Jellyseerr** (`:5055`) ‚Äî when asked for the Jellyfin server URL, enter exactly: `http://jellyfin:8096`
           ‚ö†Ô∏è Do **not** use the IP address or `localhost` ‚Äî Jellyseerr runs behind the VPN and can only reach Jellyfin by its container name.
           After completing Jellyseerr's wizard, Radarr and Sonarr will be auto-configured within ~60 seconds.
        4. **Add indexers** in Prowlarr (`:9696`) ‚Äî tag any Cloudflare-protected ones with `flaresolverr`.
